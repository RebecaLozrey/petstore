<?php

/**
*Implements hook_menu()
*
*/

function petstore_menu(){
	$items = array();

		$items['petstore-table-url2'] = array(
		'title' => 'Simple Table of Pets',
		'type' => MENU_NORMAL_ITEM,
		'access callback' => TRUE,
		'page callback' => 'petstore_table2',
	);
	$items['petstore-url'] = array(
		'title' => 'Add Pets to Pet Store',
		'type' => MENU_NORMAL_ITEM,
		'access callback' => TRUE,
		'page callback' => 'drupal_get_form',
		'page arguments' => array('petstore_form'),
	);
		
	return $items;
}

/**
*Theme template for petstore
*/

function petstore_form($form, &$form_state){

	$form['pet_name'] = array(
		'#type' => 'textfield',
		'#title' => t('Your pets name:'),
		'#size' => 60,
		'#maxlength' => 120,
		'#required' => TRUE,
	);
	$form['submit'] = array(
		'#type' => 'submit',
		'#value' => t('Enviar'),
	);
	return $form;
}


function petstore_form_submit($form, &$form_state) {
	$result = $form_state['input']['pet_name'];
	drupal_set_message('<pre>'.var_export($form_state,true).'</pre>');
}


/**
*Petstore TABLE
*
*/

function petstore_table2(){
	ini_set("allow_url_fopen", 1);
	$rows = array();
	$ceiling = 50;
	
	for($i = 0; $i < $ceiling; $i++){	
		$pid = $i + 1;
		$uri = 'https://petstore.swagger.io/v2/pet/'.$pid;
		$uri_headers = @get_headers($uri);
		
		if($uri_headers[0] == 'HTTP/1.1 404 Not Found') {
			$response = false;
		}
		else {
			$response = file_get_contents($uri);
		}
		if ($response) {
		
			$obj = json_decode($response, true);
			
			$pet_id = $obj['id'];
			if (isset($obj['Category']['id'])) {
				$pet_cat_id = $obj['Category']['id'];
				}
				else{$pet_cat_id = '0';
				}
			if (isset($obj['Category']['id'])) {
				$pet_cat_na = $obj['Category']['name'];
				}
				else{$pet_cat_na = 'null';
				}
			$pet_name = $obj['name'];
			$photoU = $obj['photoUrls'];
			$pet_status = $obj['status'];
			
			$rows[$i] = array(
				$pet_id,
				$pet_cat_id,
				$pet_cat_na,
				$pet_name,
				$photoU,
				$pet_status
			);
		} else {
			$rows[$i] = array();
		}
	}
	$header = array(t('PET ID'),t('CATEGORY_ID'),t('CATEGORY_NAME'),t('NAME'),t('IMAGE'),t('STATUS'));
	
	return theme('table', array('header' => $header, 'rows' => $rows));
}
